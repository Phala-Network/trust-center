# DStack Verifier - Production Docker Compose
services:
  # Redis Queue
  redis:
    image: redis:8-alpine
    container_name: dstack-verifier-redis
    restart: unless-stopped

  # DStack Verifier Server
  server:
    platform: linux/amd64
    image: kdon1204/dstack-verifier:latest
    container_name: dstack-verifier-server
    restart: unless-stopped
    pull_policy: always
    depends_on:
      - redis
    volumes:
      # Persist downloaded dstack images across container restarts
      - dstack_images:/app/packages/verifier/external/dstack-images
    environment:
      # Database configuration (using Supabase in production)
      DATABASE_URL: ${DATABASE_URL}

      # Redis configuration (using local Redis)
      REDIS_URL: redis://redis:6379

      # Application configuration
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}

      # Queue configuration
      QUEUE_NAME: ${QUEUE_NAME:-verification-queue}
      QUEUE_CONCURRENCY: ${QUEUE_CONCURRENCY:-20}
      QUEUE_MAX_ATTEMPTS: ${QUEUE_MAX_ATTEMPTS:-1}
      QUEUE_BACKOFF_DELAY: ${QUEUE_BACKOFF_DELAY:-2000}

      # Production logging
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # S3 Storage
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_BUCKET: ${S3_BUCKET}

      # Blockchain RPC URLs
      ETHEREUM_RPC_URL: ${ETHEREUM_RPC_URL:-}
      BASE_RPC_URL: ${BASE_RPC_URL:-}

      # Cron API (required)
      CRON_API_KEY: ${CRON_API_KEY}

      # Cron patterns (optional, defaults: profile=1min, app=1min, tasks=5min)
      PROFILE_CRON_PATTERN: ${PROFILE_CRON_PATTERN:-*/1 * * * *}
      APP_CRON_PATTERN: ${APP_CRON_PATTERN:-*/1 * * * *}
      TASKS_CRON_PATTERN: ${TASKS_CRON_PATTERN:-*/5 * * * *}

      # Phala Cloud API sync (optional)
      PHALA_CLOUD_API_KEY: ${PHALA_CLOUD_API_KEY:-}
    ports:
      - "${PORT:-3000}:${PORT:-3000}"

volumes:
  dstack_images:
