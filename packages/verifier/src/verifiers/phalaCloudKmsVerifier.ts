import {safeParseEventLog} from '../schemas'
import {
  type AppInfo,
  convertGuestAgentInfoToAppInfo,
  type QuoteData,
} from '../types'
import type {KmsInfo} from '../utils/dstackContract'
import {KmsVerifier} from './kmsVerifier'

/**
 * Phala Cloud-specific KMS verifier implementation.
 *
 * This verifier uses kms_guest_agent_info from the Cloud API response
 * to get KMS application information, avoiding the need for separate API calls.
 */
export class PhalaCloudKmsVerifier extends KmsVerifier {
  protected override async getAppInfo(): Promise<AppInfo> {
    // Use kms_guest_agent_info from SystemInfo if available
    if (this.systemInfo.kms_guest_agent_info) {
      return convertGuestAgentInfoToAppInfo(this.systemInfo.kms_guest_agent_info)
    }

    // Fallback: This should not happen with the new API, but kept for safety
    throw new Error(
      'kms_guest_agent_info not available in SystemInfo. This KMS version may not be supported.',
    )
  }

  protected override async getQuote(): Promise<QuoteData> {
    // First try to get quote from smart contract (for on-chain governance)
    if (this.registrySmartContract) {
      return super.getQuote()
    }

    // For Phala hosted KMS (non-on-chain), use hardcoded values
    // This is legacy support for dstack-pha-* domains
    if (/^https:\/\/kms\.dstack-pha-.*\.phala\.network$/.test(this.kmsInfo.url)) {
      const kmsInfo: KmsInfo = {
        caPubkey:
          '0x3059301306072a8648ce3d020106082a8648ce3d030107034200048844eb42ccdf8c52fd4f174f362fcb9bbd19c45fd48f1edec2d8f1ca23536ec1a74021b4cee610c074f8294d431b2b7fee2c39e5333fdaf0a4522d43fb159d9f',
        eventlog:
          '0x5b7b22696d72223a302c226576656e745f74797065223a323134373438333635392c22646967657374223a22306238373732653562306234316238336536303434613638333937653032663439666234373036366234666265343931376561326334356336346633323366646163626233373934386638323165626166386263396339333862613861373439222c226576656e74223a22222c226576656e745f7061796c6f6164223a22303935343634373835343631363236633635303030313030303030303030303030303030616639366262393366326239623834653934363265306261373435363432333630303930383030303030303030303030227d2c7b22696d72223a302c226576656e745f74797065223a323134373438333635382c22646967657374223a22333434626335316339383062613632316161613030646133656437343336663764366535343931393764666536393935313564666132633635383364393565363431326166323163303937643437333135353837356666643536316436373930222c226576656e74223a22222c226576656e745f7061796c6f6164223a223239343637363238353835383538353835383538353835383264353835383538353832643538353835383538326435383538353835383264353835383538353835383538353835383538353835383538323930303030303063306666303030303030303030303430303830303030303030303030227d2c7b22696d72223a302c226576656e745f74797065223a323134373438333634392c22646967657374223a22396463336131663830626365633931353339316463646135666662623135653734313966373765616234363262626637326234323136366662373064353033323565333762333666393335333761383633373639626366396265646165366662222c226576656e74223a22222c226576656e745f7061796c6f6164223a223631646665343862636139336432313161613064303065303938303332623863306130303030303030303030303030303030303030303030303030303030303035333030363530303633303037353030373230303635303034323030366630303666303037343030227d2c7b22696d72223a302c226576656e745f74797065223a323134373438333634392c22646967657374223a22366632653363626331346639646566383639383066356636366664383565393964363365363961373330313465643861353633336365353665636135623634623639323130386335363131306532326163616463656635386333323530663162222c226576656e74223a22222c226576656e745f7061796c6f6164223a22363164666534386263613933643231316161306430306530393830333262386330323030303030303030303030303030303030303030303030303030303030303530303034623030227d2c7b22696d72223a302c226576656e745f74797065223a323134373438333634392c22646967657374223a22643630376330656662343163306437353764363962636130363135633361396163306231646230366335353764393932653930366336623764656534306530653033313634306337626664376263643335383434656639656465616463366639222c226576656e74223a22222c226576656e745f7061796c6f6164223a2236316466653438626361393364323131616130643030653039383033326238633033303030303030303030303030303030303030303030303030303030303030346230303435303034623030227d2c7b22696d72223a302c226576656e745f74797065223a323134373438333634392c22646967657374223a22303861373466383936336233333761636236633933363832663933343439363337333637396464323661663130383963623465616630633330636632363061313265383134383536333835616238383433653536613961636561313965313237222c226576656e74223a22222c226576656e745f7061796c6f6164223a22636262323139643733613364393634356133626364616430306536373635366630323030303030303030303030303030303030303030303030303030303030303634303036323030227d2c7b22696d72223a302c226576656e745f74797065223a323134373438333634392c22646967657374223a22313863633665303166306336656139396161323366386132383034323365393461643831643936643061656235313830353034666330663761343063623336313964643339626436613935656331363830613836656436616230663938323864222c226576656e74223a22222c226576656e745f7061796c6f6164223a2263626232313964373361336439363435613362636461643030653637363536663033303030303030303030303030303030303030303030303030303030303030363430303632303037383030227d2c7b22696d72223a302c226576656e745f74797065223a342c22646967657374223a22333934333431623731383263643232376335633662303765663830303063646664383631333663343239326238653537363537336164376564396165343130313966353831386234623937316339656666633630653161643966313238396630222c226576656e74223a22222c226576656e745f7061796c6f6164223a223030303030303030227d2c7b22696d72223a302c226576656e745f74797065223a31302c22646967657374223a22333937343064613265613165376536633639653565363536393735356232616436643632326138613939383361326335623332643535373436353964626463346361386239356231633736366264363130626335633236646364653834326638222c226576656e74223a22222c226576656e745f7061796c6f6164223a22343134333530343932303434343135343431227d2c7b22696d72223a302c226576656e745f74797065223a31302c22646967657374223a22363338356238396432646563623364653637386435316661626130666633353036383335393135383138666433656535336137333961613637386364396337366264643735356164666130616137313463663335613161626530363262323533222c226576656e74223a22222c226576656e745f7061796c6f6164223a22343134333530343932303434343135343431227d2c7b22696d72223a302c226576656e745f74797065223a31302c22646967657374223a22303537303563336361396437316539303864356365373064343333316236616164636535333331623961366135343666323232663031376662306531373937623935316133646163373266353963623139376130633839376132303163613037222c226576656e74223a22222c226576656e745f7061796c6f6164223a22343134333530343932303434343135343431227d2c7b22696d72223a312c226576656e745f74797065223a323134373438333635312c22646967657374223a22393631646233346336646463646133636262633266363131343938613734373836336436623837656133353564373362356562393832623239333961623265323735646462383365626537666461356331303862666639646637633839376265222c226576656e74223a22222c226576656e745f7061796c6f6164223a2231386530333437623030303030303030303030343661303030303030303030303030303030303030303030303030303032613030303030303030303030303030303430333134303037326637323831343461623631653434623863333965626464376638393363373034303431323030366230303635303037323030366530303635303036633030303030303766666630343030227d2c7b22696d72223a302c226576656e745f74797065223a323134373438333635302c22646967657374223a22316464366637623435376164383830643834306434316339363132383362616236383865393465346235393335396561343536383635383165393066656363656133633632346231323236313133663832346633313565623630616530613763222c226576656e74223a22222c226576656e745f7061796c6f6164223a223631646665343862636139336432313161613064303065303938303332623863303930303030303030303030303030303032303030303030303030303030303034323030366630303666303037343030346630303732303036343030363530303732303030303030227d2c7b22696d72223a302c226576656e745f74797065223a323134373438333635302c22646967657374223a22323361646130376635323631663132663334613062643865343637363039363264366234643537366134313666316665613163363462633635366231643238656163663730343761653665393637633538666432613938626661373463323938222c226576656e74223a22222c226576656e745f7061796c6f6164223a2236316466653438626361393364323131616130643030653039383033326238633038303030303030303030303030303033653030303030303030303030303030343230303666303036663030373430303330303033303030333030303330303030393031303030303263303035353030363930303431303037303030373030303030303030343037313430306339626462383763656266383334346661616561336565346166363531366131303430363134303032316161326334363134373630333435383336653861623666343636323333313766666630343030227d2c7b22696d72223a312c226576656e745f74797065223a323134373438333635352c22646967657374223a22373761306461623233313262346531653537613834643836356132316535623265653864363737613231303132616461383139643061393839383830373864336437343066363334366266653061626161393338636132303433396138643731222c226576656e74223a22222c226576656e745f7061796c6f6164223a223433363136633663363936653637323034353436343932303431373037303663363936333631373436393666366532303636373236663664323034323666366637343230346637303734363936663665227d2c7b22696d72223a312c226576656e745f74797065223a342c22646967657374223a22333934333431623731383263643232376335633662303765663830303063646664383631333663343239326238653537363537336164376564396165343130313966353831386234623937316339656666633630653161643966313238396630222c226576656e74223a22222c226576656e745f7061796c6f6164223a223030303030303030227d2c7b22696d72223a322c226576656e745f74797065223a362c22646967657374223a22653437383437303231363835343437373831336439313531373464636633636462323535333037653631633039393165663064646335393835646137663136633939633864643233636662376632636662656330316535373037383437643766222c226576656e74223a22222c226576656e745f7061796c6f6164223a226564323233623866316130303030303034633466343134343435343435663439346434313437343533613361346336663631363434663730373436393666366537333030227d2c7b22696d72223a322c226576656e745f74797065223a362c22646967657374223a22396339333163323462666161303937633833333330613262616532333965346538363961303666313963336234393539656231623733353761396163633236343266316332363862383164303562666536383665353936363831636438396466222c226576656e74223a22222c226576656e745f7061796c6f6164223a22656332323362386630643030303030303463363936653735373832303639366536393734373236343030227d2c7b22696d72223a312c226576656e745f74797065223a323134373438333635352c22646967657374223a22323134623062656631333739373536303131333434383737373433666463326135333832626163366537303336326436323463636633663635343430376331623462616466376438663932393564643364616264656636356232373637376530222c226576656e74223a22222c226576656e745f7061796c6f6164223a2234353738363937343230343236663666373432303533363537323736363936333635373332303439366537363666363336313734363936663665227d2c7b22696d72223a312c226576656e745f74797065223a323134373438333635352c22646967657374223a22306132653031633835646561653731386135333061643863366432306138343030396261626536633839383932363965393530643863663434306336653939373639356536346434353563343137346136353263643038306636323330623734222c226576656e74223a22222c226576656e745f7061796c6f6164223a223435373836393734323034323666366637343230353336353732373636393633363537333230353236353734373537323665363536343230373736393734363832303533373536333633363537333733227d2c7b22696d72223a332c226576656e745f74797065223a3133343231373732392c22646967657374223a22663939373430323065663530373036383138333331336430636138303865306431636139623264316164306336316635373834653731353763333632633036353336663564646163646164343435313639336634386663633732666666363234222c226576656e74223a2273797374656d2d707265706172696e67222c226576656e745f7061796c6f6164223a22227d2c7b22696d72223a332c226576656e745f74797065223a3133343231373732392c22646967657374223a22613834383834363730346363353436663666316630373461373435333338303038356535613166616332663131363036663131363636366666653533633233363834653536326233346636613130663537323638613535386437383536346164222c226576656e74223a226170702d6964222c226576656e745f7061796c6f6164223a2238646433383665636630383838666263613033653237313062646436653438613834303438616135227d2c7b22696d72223a332c226576656e745f74797065223a3133343231373732392c22646967657374223a22626164316465393439646133303030643562643732346632623531353931313764653538333761336532633864663534303761343236383739383833643165346562326663373666336432303166356239336339316637343939663637363962222c226576656e74223a22636f6d706f73652d68617368222c226576656e745f7061796c6f6164223a2238646433383665636630383838666263613033653237313062646436653438613834303438616135353065353038613832326539643732303864303662396239227d2c7b22696d72223a332c226576656e745f74797065223a3133343231373732392c22646967657374223a22333035613632653330653866346361373931393436633365646536373535636661636562653032626539313031663062636366323539313530396130633865383039356263383362336435336266633564373064366337636637383133666335222c226576656e74223a22696e7374616e63652d6964222c226576656e745f7061796c6f6164223a22227d2c7b22696d72223a332c226576656e745f74797065223a3133343231373732392c22646967657374223a22393862643765366264333935323732306236353032376664343934383334303435643036623461373134626637333761303662383734363338623365613030666634303266376635383365336533623035653932316338353730343333616336222c226576656e74223a22626f6f742d6d722d646f6e65222c226576656e745f7061796c6f6164223a22227d2c7b22696d72223a332c226576656e745f74797065223a3133343231373732392c22646967657374223a22373463613933396238633363373461616233633330393636613738386637373433393531643534613933366137313164643031343232663030336666396466363636366633636335343937356432653466333563383239383635353833663066222c226576656e74223a226b65792d70726f7669646572222c226576656e745f7061796c6f6164223a2237623232366536313664363532323361323236633666363336313663326437333637373832323263323236393634323233613232333136323337363133343339333333373338333433303333333233343339363233363339333833363631333933303337333833343334363336313632333033393332333136353633363133333332363436343334333736353336333533373636333336333331333033333331333136333633363136353633363336363338363232323764227d2c7b22696d72223a332c226576656e745f74797065223a3133343231373732392c22646967657374223a22316137366232613830613062653731656165353966383039343564383736333531613761336662386539666431666631636564653537333461613834656131316664373262346564666262366630346535613835656464313134633735316264222c226576656e74223a2273797374656d2d7265616479222c226576656e745f7061796c6f6164223a22227d5d',
        k256Pubkey:
          '0x0334c76e0c3f52ec64cbf9bbf5c910c272330166fd656c0a86bb330963e46910e1',
        quote:
          '0x040002008100000000000000939a7233f79c4ca9940a0db3957f06075fdd5ea20205694b1240ffe054cfd68300000000060104000000000000000000000000005b38e33a6487958b72c3c12a938eaa5e3fd4510c51aeeab58c7d5ecee41d7c436489d6c8e4f92f160b7cad34207b00c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000702000000000000f06dfda6dce1cf904d4e2bab1dc370634cf95cefa2ceb2de2eee127c9382698090d7a4a13e14c536ec6c9c3c8fa87077018dd386ecf0888fbca03e2710bdd6e48a84048aa550e508a822e9d7208d06b9b900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000068102e7b524af310f7b7d426ce75481e36c40f5d513a9009c046e9d37e31551f0134d954b496a3357fd61d03f07ffe9619d16ecd33220ee15965b4fb28a0661e85ec4cad0a20d920bf4028f58ad014b262af3c9b0530f283e7d032e7bdca630805ac95f479e23db627217ce58b2587483c9ee4f374a7d8ebee3b812b8cfd8fd8fca04696369c33bd5279590d83e713c0f9903e1bdcc5fb94e865af1667928d320aaa6f108a22200d521518b7a6e87761db629fb671fcccfd4f217cc7cd33666a8e695b1d3d63775ce4c6162fcabb0666b045e2f35323f8ce8f07f26e3bbf62110000000000000000000000000000000000000000000000000000000000000000d0100000d22296c2edbf8b12ad86fcf424ad8c065ddf10aba3946289ec3a8cdf419c388f9742968154d0caded6d924e8ffdf8fa9c962dbb8a3f62f19299d76ef828d113c279c9edd68fab43c656735ef76079743e58b58bd522e5d9653186212a3659c973f9af53b58e80c267795bee407bed6b503e10a53399eba560159e8b5716df91d06004a1000000404090905ff00020000000000000000000000000000000000000000000000000000000000000000000000000000000015000000000000000700000000000000e5a3a7b5d830c2953b98534c6c59a3a34fdc34e933f7f5898f0a85cf08846bca0000000000000000000000000000000000000000000000000000000000000000dc9e2a7c6f948f17474e34a7fc43ed030f7c1563f1babddf6340c82e0e54a8c5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e3e85f8a38b1ab3f2d2d7b6f27d990848ba3edbabfba547d9a0cf66fed1e17a0000000000000000000000000000000000000000000000000000000000000000caab06c10e5910cc4f92334d7b1edfc87cf753b7df1c3c791c9a3d1bab34ed12a504a6daafcf2ac91d96f5d33a0b9840692d94196cda44a6acdb6e9274120dbb2000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f0500620e00002d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d494945386a4343424a6567417749424167495550564e565753427351747a4344656468716a7953754f303562474177436759494b6f5a497a6a3045417749770a634445694d434147413155454177775a535735305a577767553064594946424453794251624746305a6d397962534244515445614d42674741315545436777520a535735305a577767513239796347397959585270623234784644415342674e564241634d43314e68626e526849454e7359584a684d51737743515944565151490a44414a445154454c4d416b474131554542684d4356564d774868634e4d6a55774e7a4d784d4463794f444d355768634e4d7a49774e7a4d784d4463794f444d350a576a42774d534977494159445651514444426c4a626e526c624342545231676755454e4c49454e6c636e52705a6d6c6a5958526c4d526f77474159445651514b0a4442464a626e526c6243424462334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e560a4241674d416b4e424d517377435159445651514745774a56557a425a4d424d4742797147534d34394167454743437147534d34394177454841304941424e715a0a71516251626436394e58534e554846356c3055616c3865465175706d2f774553684d673864416b6c536f5376576348324d557841336155414b6a6a715058326d0a524179766c6f57533364356b56706a587275696a67674d4e4d4949444354416642674e5648534d4547444157674253566231334e765276683655424a796454300a4d383442567776655644427242674e56485238455a4442694d47436758714263686c706f64485277637a6f764c32467761533530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c334e6e6543396a5a584a3061575a7059324630615739754c3359304c33426a61324e796244396a595431770a624746305a6d397962535a6c626d4e765a476c755a7a316b5a584977485159445652304f4242594546496c7631526b35584c345a336c434c4f673368334931470a42616d624d41344741315564447745422f775145417749477744414d42674e5648524d4241663845416a41414d4949434f67594a4b6f5a496876684e415130420a424949434b7a4343416963774867594b4b6f5a496876684e41513042415151514e55347148486e4a6a6f46795071744c654c6d51707a434341575147436971470a534962345451454e41514977676746554d42414743797147534962345451454e41514942416745454d42414743797147534962345451454e41514943416745450a4d42414743797147534962345451454e41514944416745434d42414743797147534962345451454e41514945416745434d42414743797147534962345451454e0a41514946416745464d42454743797147534962345451454e41514947416749412f7a415142677371686b69472b453042445145434277494241444151426773710a686b69472b4530424451454343414942416a415142677371686b69472b45304244514543435149424144415142677371686b69472b45304244514543436749420a4144415142677371686b69472b45304244514543437749424144415142677371686b69472b45304244514543444149424144415142677371686b69472b4530420a44514543445149424144415142677371686b69472b45304244514543446749424144415142677371686b69472b453042445145434477494241444151426773710a686b69472b45304244514543454149424144415142677371686b69472b45304244514543455149424454416642677371686b69472b45304244514543456751510a424151434167582f4141494141414141414141414144415142676f71686b69472b45304244514544424149414144415542676f71686b69472b453042445145450a424159676f473841414141774477594b4b6f5a496876684e4151304242516f424154416542676f71686b69472b453042445145474242416d462f5463654962390a51635534474f6e6c545766304d45514743697147534962345451454e415163774e6a415142677371686b69472b45304244514548415145422f7a4151426773710a686b69472b45304244514548416745422f7a415142677371686b69472b45304244514548417745422f7a414b42676771686b6a4f5051514441674e4a414442470a416945417346356576364f774e6b727077417563594256443661484f42786e6c49354e744d4c424f33624f3962774143495143536e6f7678305050694b677a750a734c583735636176303479474c3076722b314f6761757877695930546a413d3d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436c6a4343416a32674177494241674956414a567658633239472b487051456e4a3150517a7a674658433935554d416f4743437147534d343942414d430a4d476778476a415942674e5642414d4d45556c756447567349464e48574342536232393049454e424d526f77474159445651514b4442464a626e526c624342440a62334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e564241674d416b4e424d5173770a435159445651514745774a56557a4165467730784f4441314d6a45784d4455774d5442614677307a4d7a41314d6a45784d4455774d5442614d484178496a41670a42674e5642414d4d47556c756447567349464e4857434251513073675547786864475a76636d306751304578476a415942674e5642416f4d45556c75644756730a49454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b474131554543417743513045780a437a414a42674e5642415954416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741454e53422f377432316c58534f0a3243757a7078773734654a423732457944476757357258437478327456544c7136684b6b367a2b5569525a436e71523770734f766771466553786c6d546c4a6c0a65546d693257597a33714f42757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f536347724442530a42674e5648523845537a424a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e5648513445466751556c5739640a7a62306234656c4153636e553944504f4156634c336c517744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159420a4166384341514177436759494b6f5a497a6a30454177494452774177524149675873566b6930772b6936565947573355462f32327561586530594a446a3155650a6e412b546a44316169356343494359623153416d4435786b66545670766f34556f79695359787244574c6d5552344349394e4b7966504e2b0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436a7a4343416a53674177494241674955496d554d316c71644e496e7a6737535655723951477a6b6e42717777436759494b6f5a497a6a3045417749770a614445614d4267474131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e760a636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a0a42674e5642415954416c56544d423458445445344d4455794d5445774e4455784d466f58445451354d54497a4d54497a4e546b314f566f77614445614d4267470a4131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e76636e4276636d46300a615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a42674e56424159540a416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a3044415163445167414543366e45774d4449595a4f6a2f69505773437a61454b69370a314f694f534c52466857476a626e42564a66566e6b59347533496a6b4459594c304d784f346d717379596a6c42616c54565978465032734a424b357a6c4b4f420a757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f5363477244425342674e5648523845537a424a0a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b63325679646d6c6a5a584d75615735300a5a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e564851344546675155496d554d316c71644e496e7a673753560a55723951477a6b6e4271777744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159424166384341514577436759490a4b6f5a497a6a3045417749445351417752674968414f572f35516b522b533943695344634e6f6f774c7550524c735747662f59693747535839344267775477670a41694541344a306c72486f4d732b586f356f2f7358364f39515778485241765a55474f6452513763767152586171493d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
      }

      const eventLogBuffer = Buffer.from(
        kmsInfo.eventlog.replace('0x', ''),
        'hex',
      ).toString('utf8')

      this.certificateAuthorityPublicKey = kmsInfo.caPubkey

      return {
        quote: kmsInfo.quote,
        eventlog: safeParseEventLog(eventLogBuffer),
      }
    }

    throw new Error(
      `Quote retrieval not supported for domain: ${this.kmsInfo.url}`,
    )
  }
}
